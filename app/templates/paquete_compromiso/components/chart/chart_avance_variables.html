
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-baby mr-1"></i>
                        CRED
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-cred" style="min-height: 250px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-syringe mr-1"></i>
                    VACUNACION
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-vacunacion" style="min-height: 250px;"></div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-brain mr-1"></i>
                    SUPLEMENTACION
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-suplementacion" style="min-height: 250px;"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-2">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-vial mr-1"></i>
                    DOSAJE HB
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-hemoglobina" style="min-height: 250px;"></div>
            </div>
        </div>
    </div>
        
    <div class="col-md-1">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-id-card mr-1"></i>
                    DNI
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="chart-dni" style="min-height: 250px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
window.renderChartAvanceVariables = function(data, params) {
    if (typeof echarts === "undefined") {
        console.error("ECharts no está cargado.");
        return;
    }

    const chartDOMElements = {
        cred: document.getElementById("chart-cred"),
        vacunacion: document.getElementById("chart-vacunacion"),
        suplementacion: document.getElementById("chart-suplementacion"),
        hemoglobina: document.getElementById("chart-hemoglobina"),
        dni: document.getElementById("chart-dni")
    };

    const charts = {};

    function createOrUpdateChart(chartKey, labels, chartData) {
        const chartDOMElement = chartDOMElements[chartKey];
        if (!chartDOMElement) return;

        let chartInstance = echarts.getInstanceByDom(chartDOMElement);
        if (chartInstance) {
            chartInstance.dispose();
        }
        chartInstance = echarts.init(chartDOMElement);
        charts[chartKey] = chartInstance;

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function (params) {
                    const dataItem = params[0].data;
                    return `Alcanzado: ${dataItem.numerator}<br/>Avance: ${dataItem.value.toFixed(1)}%`;
                }
            },
            toolbox: { feature: { saveAsImage: {} } },
            xAxis: {
                type: 'category',
                data: labels,
                axisLabel: { rotate: 45, fontSize: 8 }
            },
            yAxis: {
                type: 'value',
                max: 100,
                axisLabel: { formatter: '{value}%', fontSize: 8 }
            },
            series: [{
                name: 'Avance',
                type: 'bar',
                data: chartData,
                itemStyle: { color: '#5070dd' },
                label: {
                    show: true,
                    position: 'top',
                    formatter: function(params) {
                        return params.data.numerator;
                    },
                    fontSize: 8,
                    color: 'black',
                    fontWeight: 'bold'
                },
                markLine: {
                    symbol: 'none',
                    lineStyle: { type: 'dashed', color: 'red' },
                    data: [{ yAxis: 75, name: 'M' }],
                    label: { 
                        show: true, 
                        formatter: `M: 75%`, 
                        position: 'end', 
                        offset: [0, -14], 
                        textStyle: { fontSize: 8 } 
                    }
                }
            }]
        };
        chartInstance.setOption(option);
    }

    try {
        const extractValue = (rawValue) => {
            if (rawValue == null) return 0;
            const value = Array.isArray(rawValue) ? rawValue[0] : rawValue;
            return parseFloat(value) || 0;
        };

        const indicatorGroups = {
          cred: [
            { title: 'CRED', avance_key: 'v_avance_cred', num_key: 'v_num_cred' },
            { title: 'CRED RN', avance_key: 'v_avance_cred_rn', num_key: 'v_num_cred_rn' },
            { title: 'CRED MENSUAL', avance_key: 'v_avance_cred_mensual', num_key: 'v_num_cred_mensual' },
          ],
          vacunacion: [
            { title: 'VACUNAS', avance_key: 'v_avance_vac', num_key: 'v_num_vac' },
            { title: 'NEUMOCOCO', avance_key: 'v_avance_vac_antineumococica', num_key: 'v_num_vac_antineumococica' },
            { title: 'ANTIPOLIO', avance_key: 'v_avance_vac_antipolio', num_key: 'v_num_vac_antipolio' },
            { title: 'PENTAVALENTE', avance_key: 'v_avance_vac_pentavalente', num_key: 'v_num_vac_pentavalente' },
            { title: 'ROTAVIRUS', avance_key: 'v_avance_vac_rotavirus', num_key: 'v_num_vac_rotavirus' },
          ],
          suplementacion: [
            { title: 'ESQUEMA', avance_key: 'v_avance_esq', num_key: 'v_num_esq' },
            { title: 'SUP 4M', avance_key: 'v_avance_esq4M', num_key: 'v_num_esq4M' },
            { title: 'SUP 6M', avance_key: 'v_avance_esq6M', num_key: 'v_num_esq6M' },
            { title: 'SUP 6M TRAT.', avance_key: 'v_avance_esq6M_trat', num_key: 'v_num_esq6M_trat' },
            { title: 'SUP 6M MULTI.', avance_key: 'v_avance_esq6M_multi', num_key: 'v_num_esq6M_multi' },
          ],
          hemoglobina: [
            { title: 'DOSAJE HB', avance_key: 'v_avance_num_dosaje_Hb', num_key: 'v_num_dosaje_Hb' },
          ],
          dni: [
            { title: 'EMISIÓN DNI', avance_key: 'v_avance_DNIemision', num_key: 'v_num_DNIemision' }
          ]
        };

        const specialColor = '#505372';

        for (const group in indicatorGroups) {
            const labels = indicatorGroups[group].map(item => item.title);
            const chartData = indicatorGroups[group].map((item, index) => {
                const value = extractValue(data[item.avance_key]);
                const numerator = extractValue(data[item.num_key]);
                const dataItem = { value: value, numerator: numerator };
                if (index === 0) {
                    dataItem.itemStyle = { color: specialColor };
                }
                if (item.title === 'SUP 6M TRAT.' || item.title === 'SUP 6M MULTI.') {
                    dataItem.itemStyle = { color: '#0ca8df' };
                }
                return dataItem;
            });
            createOrUpdateChart(group, labels, chartData);
        }
    } catch (error) {
        console.error("Error al renderizar los gráficos de variables:", error);
    }

    window.addEventListener('resize', function() {
        for (const key in charts) {
            if(charts[key]) {
                charts[key].resize();
            }
        }
    });
};
</script>