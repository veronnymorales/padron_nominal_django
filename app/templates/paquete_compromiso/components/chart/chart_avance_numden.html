<!-- Card para mostrar numerador y denominador -->
<script>
  (function () {
    console.log("=== INICIANDO CHART_AVANCE_NUMDEN SIMPLE ===");

    function initChart() {
      const container = document.getElementById(
        "detalle-avance-numden-container"
      );

      if (!container) {
        console.error("Contenedor no encontrado");
        return;
      }

      console.log("Contenedor encontrado:", container);

      function renderCard(numerador, denominador) {
        const brecha = denominador - numerador;
        const avance = denominador > 0 ? (numerador / denominador) * 100 : 0;

        let clasificacion, colorClass, iconClass;
        if (avance >= 67) {
          clasificacion = "CUMPLE";
          colorClass = "success";
          iconClass = "check-circle";
        } else if (avance >= 33) {
          clasificacion = "PROCESO";
          colorClass = "warning";
          iconClass = "clock";
        } else {
          clasificacion = "RIESGO";
          colorClass = "danger";
          iconClass = "exclamation-triangle";
        }

        const cardHTML = `
          <div class="card border-${colorClass}">
            <div class="card-header bg-${colorClass} text-white">
              <h6 class="mb-0"><i class="fas fa-${iconClass} mr-2"></i>RESUMEN </h6>
            </div>
            <div class="card-body p-2">
              <div class="row text-center">
                <div class="col-4">
                  <div class="border-right">
                    <i class="fas fa-users text-success mb-1" style="font-size: 0.8rem;"></i>
                    <h6 class="text-success mb-0 style="font-size: 0.8rem;"">Den</h6>
                    <h5 class="font-weight-bold mb-0">${denominador.toLocaleString()}</h5>
                    <small class="text-muted">Meta</small>
                  </div>
                </div>
                <div class="col-4">
                  <div class="border-right">
                    <i class="fas fa-rocket text-primary mb-1" style="font-size: 0.8rem;"></i>
                    <h6 class="text-primary mb-0 style="font-size: 0.8rem;"">Num</h6>
                    <h5 class="font-weight-bold mb-0">${numerador.toLocaleString()}</h5>
                    <small class="text-muted">Alcanzado</small>
                  </div>
                </div>
                <div class="col-4">
                  <i class="fas fa-percentage text-${colorClass} mb-1" style="font-size: 0.8rem;"></i>
                  <h6 class="text-${colorClass} mb-0">Avance</h6>
                  <h5 class="font-weight-bold mb-0">${avance.toFixed(1)}%</h5>
                  <small class="text-${colorClass}">${clasificacion}</small>
                </div>
              </div>
              <hr class="my-2">
              <div class="row text-center">
                <div class="col-12">
                  <small class="text-muted">
                    <i class="fas fa-minus-circle text-danger mr-1"></i>
                    Brecha: <strong>${brecha.toLocaleString()}</strong> casos por atender
                  </small>
                </div>
              </div>
            </div>
          </div>
        `;

        container.innerHTML = cardHTML;

        console.log(
          "Card renderizada con innerHTML: Num=" +
            numerador +
            ", Den=" +
            denominador +
            ", Avance=" +
            avance.toFixed(1) +
            "%"
        );
      }

      function loadData(params) {
        params = params || {};
        const queryString = new URLSearchParams(params).toString();
        const url =
          "{% url 'index_paquete_compromiso' %}" +
          (queryString ? "?" + queryString : "");

        console.log("Cargando datos desde:", url);

        fetch(url, {
          headers: { "X-Requested-With": "XMLHttpRequest" },
          cache: "no-cache",
        })
          .then(function (response) {
            return response.json();
          })
          .then(function (data) {
            console.log("Datos recibidos:", data);

            // Helper to extract value, whether it's in an array or not
            function extractValue(rawValue) {
              if (rawValue == null) return null; // Handles null or undefined
              const value = Array.isArray(rawValue) ? rawValue[0] : rawValue;
              if (value == null || value === "") return null;
              return value;
            }

            const num_val = extractValue(data.r_numerador_resumen);
            const den_val = extractValue(data.r_denominador_resumen);

            if (num_val != null && den_val != null) {
              const numerador = parseInt(num_val, 10) || 0;
              const denominador = parseInt(den_val, 10) || 0;
              renderCard(numerador, denominador);
            } else {
              container.innerHTML =
                '<div class="alert alert-info">No hay datos disponibles</div>';
            }
          })
          .catch(function (error) {
            console.error("Error:", error);
            container.innerHTML =
              '<div class="alert alert-danger">Error al cargar datos</div>';
          });
      }

      // Cargar datos iniciales
      loadData();

      // Escuchar eventos del formulario
      const form = document.querySelector("form");
      if (form) {
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          console.log("Submit capturado");

          const formData = new FormData(form);
          const params = {};
          for (const entry of formData.entries()) {
            const key = entry[0];
            const value = entry[1];
            if (value) {
              params[key] = value;
            }
          }

          console.log("Parámetros:", params);
          loadData(params);
        });
      }
    }

    // Inicializar cuando el DOM esté listo
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initChart);
    } else {
      initChart();
    }
  })();
</script>
