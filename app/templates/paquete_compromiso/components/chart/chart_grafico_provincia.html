<script>
window.renderChartProvincia = function(data, params) {
    const container = document.getElementById('chart_provincia_ranking');
    if (!container) {
        console.error('El contenedor para el ranking porvincia no fue encontrado.');
        return;
    }
    if (typeof echarts === "undefined") {
        console.error("ECharts no está cargado.");
        return;
    }

    let myChart = echarts.getInstanceByDom(container);
    if (myChart) {
        myChart.dispose();
    }
    myChart = echarts.init(container);

    try {
        if (!data.p_provincia || !Array.isArray(data.p_provincia) || data.p_provincia.length === 0) {
            container.innerHTML = '<p class="text-center text-info">No hay datos de provincia para mostrar.</p>';
            return;
        }

        const datosCompletos = data.p_provincia.map((Provincia, index) => ({
            p_provincia: Provincia,
            p_den: data.p_den[index] || 0,
            p_num: data.p_num[index] || 0,
            p_cob: data.p_cob[index] || 0,
            p_brecha: data.p_brecha[index] || 0
        }));

        datosCompletos.sort((a, b) => b.p_cob - a.p_cob);

        const p_provincia = datosCompletos.map(d => d.p_provincia);
        const p_den = datosCompletos.map(d => d.p_den);
        const p_num = datosCompletos.map(d => d.p_num);
        const p_cob = datosCompletos.map(d => d.p_cob);
        const p_brecha = datosCompletos.map(d => d.p_brecha);

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(function(item) {
                        if (item.seriesName === 'Cob') {
                            result += `${item.marker} ${item.seriesName}: ${parseFloat(item.value).toFixed(2)}%<br/>`;
                        } else {
                            result += `${item.marker} ${item.seriesName}: ${item.value}<br/>`;
                        }
                    });
                    const dataIndex = params[0].dataIndex;
                    if (p_brecha[dataIndex] !== undefined) {
                        const brechaMarker = '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#ff6a00;"></span>';
                        result += `${brechaMarker} Brecha: ${p_brecha[dataIndex]}<br/>`;
                    }
                    return result;
                }
            },
            legend: { data: ['Meta', 'Alcanzado', 'Cob'] },
            toolbox: { feature: { saveAsImage: {} } },
            xAxis: [{
                type: 'category',
                data: p_provincia,
                axisPointer: { type: 'shadow' },
                axisLabel: { rotate: 45, interval: 0, fontSize: 9 }
            }],
            yAxis: [
                { type: 'value', name: 'Cantidad', min: 0, axisLabel: { formatter: '{value}' } },
                { type: 'value', name: 'Cobertura (%)', min: 0, max: 100, interval: 20, axisLabel: { formatter: '{value}%' } }
            ],
            series: [
                { name: 'Meta', type: 'bar', data: p_den, label: { show: true, position: 'top', formatter: '{c}', fontSize: 10 }, itemStyle: { color: '#91cc75' } },
                { name: 'Alcanzado', type: 'bar', data: p_num, label: { show: true, position: 'top', formatter: '{c}', fontSize: 10 }, itemStyle: { color: '#5070dd' } },
                { name: 'Cob', type: 'line', yAxisIndex: 1, data: p_cob, itemStyle: { color: '#5470c6' }, label: { show: true, position: 'top', formatter: (p) => `${parseFloat(p.value).toFixed(2)}%`, fontSize: 10, fontWeight: 'bold' },
                    markLine: {
                        symbol: 'none',
                        lineStyle: { type: 'dashed', color: 'red' },
                        data: [{ yAxis: 75, name: 'M' }],
                        label: { show: true, formatter: 'M: 75%', position: 'end' }
                    }
                },
            ]
        };
        myChart.setOption(option);
    } catch (error) {
        console.error("Error al renderizar el ranking de provincias:", error);
        container.innerHTML = '<p class="text-center text-danger">Ocurrió un error al cargar el gráfico.</p>';
    }
};
</script>