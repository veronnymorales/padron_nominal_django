<!-- Card para mostrar gráficos por edades -->
<script>
window.renderChartAvanceMensual = function(data, params) {
    if (typeof echarts === "undefined") {
        console.error("ECharts no está cargado.");
        return;
    }
    const container = document.getElementById("detalle-avance-mensual-container");
    if (!container) {
        console.error('El contenedor para el gráfico de avance mensual no fue encontrado.');
        return;
    }

    try {
        // Crear la estructura de la tarjeta y el div para el gráfico
        const cardHTML = `
            <div class="card">
                <div class="card-body p-2">
                    <div id="monthly-chart-div" style="height: 178px;"></div>
                </div>
            </div>
        `;
        container.innerHTML = cardHTML;
        const chartDiv = document.getElementById('monthly-chart-div');

        let myChartRegionalMensual = echarts.getInstanceByDom(chartDiv);
        if (myChartRegionalMensual) {
            myChartRegionalMensual.dispose();
        }
        myChartRegionalMensual = echarts.init(chartDiv);

        const monthlyNum = Array.from({ length: 12 }, (_, i) => data[`num_${i + 1}`]?.[0] ?? 0);
        const monthlyDen = Array.from({ length: 12 }, (_, i) => data[`den_${i + 1}`]?.[0] ?? 0);
        const monthlyCob = Array.from({ length: 12 }, (_, i) => data[`cob_${i + 1}`]?.[0] ?? 0);

        const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SET', 'OCT', 'NOV', 'DIC'];
        const anio = params.anio || new Date().getFullYear();
        const meta = 90;
        const maxValue = 100;

        const option = {
            title: {
                text: `Avance Mensual (${anio})`,
                left: 'center',
                textStyle: { fontSize: 12, fontWeight: 'bold' }
            },
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    const idx = params[0].dataIndex;
                    return `<strong>${params[0].name}</strong><br/>
                            Den: ${monthlyDen[idx] ?? 0}<br/>
                            Num: ${monthlyNum[idx] ?? 0}<br/>
                            Cob: ${(monthlyCob[idx] ?? 0).toFixed(1)}%`;
                }
            },
            grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
            toolbox: { feature: { saveAsImage: {} } },
            xAxis: { type: 'category', data: months, axisLabel: { fontSize: 10 } },
            yAxis: { type: 'value', max: maxValue, axisLabel: { formatter: '{value}%', fontSize: 8 } },
            series: [{
                name: '% Avance',
                type: 'line',
                step: 'start',
                data: monthlyCob,
                areaStyle: {},
                label: {
                    show: true,
                    position: 'top',
                    formatter: (params) => `${params.value.toFixed(1)}%`,
                    textStyle: { fontSize: 10 }
                },
                markLine: {
                    symbol: 'none',
                    lineStyle: { type: 'dashed', color: 'red' },
                    data: [{ yAxis: meta, name: 'M' }],
                    label: { show: true, formatter: `M: ${meta}%`, position: 'end', offset: [0, -14], textStyle: { fontSize: 8 } }
                }
            }]
        };
        myChartRegionalMensual.setOption(option);

    } catch (error) {
        console.error("Error al renderizar el gráfico de avance mensual:", error);
        container.innerHTML = `
            <div class="card">
                <div class="card-body d-flex align-items-center justify-content-center" style="height: 210px;">
                    <div class="alert alert-danger text-center m-0"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>
                </div>
            </div>
        `;
    }
}
</script>