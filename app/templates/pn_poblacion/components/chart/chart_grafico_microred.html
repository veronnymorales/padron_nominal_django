<script>
document.addEventListener("DOMContentLoaded", function () {
    // Corrección: ID consistente con el usado en el código
    const container = document.getElementById("chart_microred_ranking");
    const filtroForm = document.querySelector("form");

    function loadRankingData(params = {}) {
        const queryString = new URLSearchParams(params).toString();

        fetch(`{% url "index_pn_poblacion" %}?${queryString}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" },
        })
            .then((response) => {
                if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
            }
                return response.json();
            })
            .then((data) => {
            console.log("Datos recibidos:", data);

            if (!container) {
                console.error(
                    'El elemento contenedor "chart_microred_ranking" no fue encontrado.'
            );
                return;
            }

            // Validar que los datos existan
            if (!data.m_microred || !Array.isArray(data.m_microred)) {
                console.error("Los datos de microred no son válidos");
                container.innerHTML =
                    '<p class="text-center text-danger">Datos de microred no válidos.</p>';
                return;
            }

          // Verificar que todos los arrays tengan la misma longitud
        const arrays = [
            data.m_microred,
            data.m_denominador,
            data.m_numerador,
            data.m_cobertura,
        ];
        const lengths = arrays.map((arr) => (arr ? arr.length : 0));
        const allSameLength = lengths.every((len) => len === lengths[0]);

        if (!allSameLength) {
            console.error("Los arrays de datos no tienen la misma longitud");
            container.innerHTML =
                '<p class="text-center text-danger">Error en la estructura de datos.</p>';
            return;
        }

        // Limpiar el gráfico anterior si existe
        if (container._chartInstance) {
            container._chartInstance.dispose();
        }

        var myChart = echarts.init(container);
          // Guardar referencia para poder limpiar después
        container._chartInstance = myChart;

        // Crear un array de objetos con todos los datos relacionados
        const datosCompletos = data.m_microred.map((microred, index) => ({
            microred: microred,
            denominador: data.m_denominador[index] || 0,
            numerador: data.m_numerador[index] || 0,
            cobertura: data.m_cobertura[index] || 0,
        }));

        // Ordenar los datos por cobertura de mayor a menor
        datosCompletos.sort((a, b) => b.cobertura - a.cobertura);

        // Separar los datos ordenados en arrays individuales
        const microred = datosCompletos.map((d) => d.microred);
        const denominadores = datosCompletos.map((d) => d.denominador);
        const numeradores = datosCompletos.map((d) => d.numerador);
        const coberturas = datosCompletos.map((d) => d.cobertura);

        // Calcular el porcentaje para mostrar los primeros 10 elementos
        const totalElementos = microred.length;
        const elementosAMostrar = Math.min(10, totalElementos);
        const porcentajeFinal =
        totalElementos > 0
            ? (elementosAMostrar / totalElementos) * 100
            : 100;
        var option = {
            title: {
                text: "",
            },
            tooltip: {
                trigger: "axis",
                axisPointer: {
                type: "shadow",
            },
            formatter: function (params) {
                if (!params || params.length === 0) return "";

                let result = params[0].name + "<br/>";
                params.forEach(function (item) {
                if (item.seriesName === "Cob") {
                    result +=
                    item.marker +
                    " " +
                    item.seriesName +
                    ": " +
                    parseFloat(item.value).toFixed(2) +
                    "%<br/>";
                } else {
                    result +=
                    item.marker +
                    " " +
                    item.seriesName +
                    ": " +
                    item.value +
                    "<br/>";
                }
                });
                return result;
            },
        },
            legend: {
                data: ["Poblacion", "PN", "Cob"],
            },
            dataZoom: [
                {
                    type: "slider",
                    show: true,
                    xAxisIndex: [0],
                    start: 0,
                    end: porcentajeFinal,
                    bottom: 10,
                    height: 10,
                    handleIcon:
                        "M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23.1h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z",
                    handleSize: "80%",
                    handleStyle: {
                        color: "#fff",
                        shadowBlur: 3,
                        shadowColor: "rgba(0, 0, 0, 0.6)",
                        shadowOffsetX: 2,
                        shadowOffsetY: 2,
                    },
                    textStyle: {
                        color: "#333",
                    },
                    borderColor: "#ddd",
                },
                {
                type: "inside",
                xAxisIndex: [0],
                start: 0,
                end: porcentajeFinal,
                zoomOnMouseWheel: true,
                moveOnMouseMove: true,
                moveOnMouseWheel: false,
                },
            ],
            xAxis: [
                {
                    type: "category",
                    data: microred,
                    axisPointer: {
                        type: "shadow",
                    },
                    axisLabel: {
                        rotate: 45,
                        interval: 0,
                        fontSize: 9,
                    },
                },
            ],
            yAxis: [
                {
                    type: "value",
                    name: "Cantidad",
                    min: 0,
                    axisLabel: {
                        formatter: "{value}",
                    },
                },
                {
                    type: "value",
                    name: "Cobertura (%)",
                    min: 0,
                    max: 100,
                    interval: 20,
                    axisLabel: {
                        formatter: "{value}%",
                    },
                },
            ],
            series: [
                {
                    name: "Poblacion",
                    type: "bar",
                    data: denominadores,
                    label: {
                        show: true,
                        position: "top",
                        formatter: "{c}",
                        fontSize: 10,
                    },
                    itemStyle: {
                        color: "#91cc75",
                    },
                },
                {
                    name: "PN",
                    type: "bar",
                    data: numeradores,
                    label: {
                        show: true,
                        position: "top",
                        formatter: "{c}",
                        fontSize: 10,
                    },
                    itemStyle: {
                        color: "#fac858",
                    },
                },
                {
                    name: "Cob",
                    type: "line",
                    yAxisIndex: 1,
                    data: coberturas,
                    itemStyle: {
                        color: "#5470c6",
                    },
                    label: {
                        show: true,
                        position: "top",
                        formatter: function (params) {
                            return parseFloat(params.value).toFixed(2) + "%";
                        },
                        fontSize: 10,
                        fontWeight: "bold",
                },
                markLine: {
                    symbol: "none",
                    lineStyle: {
                        type: "dashed",
                        color: "red",
                    },
                    data: [
                        {
                            yAxis: 85,
                            name: "Meta",
                        },
                    ],
                    label: {
                        show: true,
                        formatter: "Meta: 85%",
                        position: "end",
                        },
                    },
                },
            ],
        };
        myChart.setOption(option);
        // Manejar el redimensionamiento de la ventana
        window.addEventListener("resize", function () {
            if (myChart) {
                myChart.resize();
            }
        });
    })
            .catch((error) => {
                console.error("Error al cargar los datos:", error);
                if (container) {
            container.innerHTML =
                '<p class="text-center text-danger">Ocurrió un error al cargar los datos: ' +
                    error.message +
                "</p>";
            }
        });
    }

    if (filtroForm) {
        filtroForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(filtroForm);
            const params = {};
            for (const [key, value] of formData.entries()) {
                if (value) {
                    params[key] = value;
                }
            }
            loadRankingData(params);
    });

      // Cargar datos iniciales
    filtroForm.dispatchEvent(new Event("submit"));
    } else {
        loadRankingData();
    }
});
</script>
