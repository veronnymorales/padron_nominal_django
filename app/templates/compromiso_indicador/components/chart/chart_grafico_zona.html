<script>
window.renderChartZona = function(data, params) {
    const container = document.getElementById('chart_zona_ranking');
    if (!container) {
        console.error('El contenedor para el ranking de zonas no fue encontrado.');
        return;
    }
    if (typeof echarts === "undefined") {
        console.error("ECharts no está cargado.");
        return;
    }

    let myChart = echarts.getInstanceByDom(container);
    if (myChart) {
        myChart.dispose();
    }
    myChart = echarts.init(container);

    try {
        if (!data.z_zona || !Array.isArray(data.z_zona) || data.z_zona.length === 0) {
            container.innerHTML = '<p class="text-center text-info">No hay datos de zonas para mostrar.</p>';
            return;
        }

        const datosCompletos = data.z_zona.map((zona, index) => ({
            z_zona: zona,
            z_den: data.z_den[index] || 0,
            z_num: data.z_num[index] || 0,
            z_cob: data.z_cob[index] || 0,
            z_brecha: data.z_brecha[index] || 0 
        }));

        datosCompletos.sort((a, b) => b.z_cob - a.z_cob);

        const z_zona = datosCompletos.map(d => d.z_zona);
        const z_den = datosCompletos.map(d => d.z_den);
        const z_num = datosCompletos.map(d => d.z_num);
        const z_cob = datosCompletos.map(d => d.z_cob);
        const z_brecha = datosCompletos.map(d => d.z_brecha);

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(function(item) {
                        if (item.seriesName === 'Cob') {
                            result += `${item.marker} ${item.seriesName}: ${parseFloat(item.value).toFixed(2)}%<br/>`;
                        } else {
                            result += `${item.marker} ${item.seriesName}: ${item.value}<br/>`;
                        }
                    });
                    const dataIndex = params[0].dataIndex;
                    if (z_brecha[dataIndex] !== undefined) {
                        const brechaMarker = '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#ff6a00;"></span>';
                        result += `${brechaMarker} Brecha: ${z_brecha[dataIndex]}<br/>`;
                    }
                    return result;
                }
            },
            legend: { data: ['Meta', 'Alcanzado', 'Cob'] },
            toolbox: { feature: { saveAsImage: {} } },
            xAxis: [{
                type: 'category',
                data: z_zona,
                axisPointer: { type: 'shadow' },
                axisLabel: { rotate: 45, interval: 0, fontSize: 9 }
            }],
            yAxis: [
                { type: 'value', name: 'Cantidad', min: 0, axisLabel: { formatter: '{value}' } },
                { type: 'value', name: 'Cobertura (%)', min: 0, max: 100, interval: 20, axisLabel: { formatter: '{value}%' } }
            ],
            series: [
                { name: 'Meta', type: 'bar', data: z_den, label: { show: true, position: 'top', formatter: '{c}', fontSize: 10 }, itemStyle: { color: '#91cc75' } },
                { name: 'Alcanzado', type: 'bar', data: z_num, label: { show: true, position: 'top', formatter: '{c}', fontSize: 10 }, itemStyle: { color: '#5070dd' } },
                { name: 'Cob', type: 'line', yAxisIndex: 1, data: z_cob, itemStyle: { color: '#5470c6' }, label: { show: true, position: 'top', formatter: (p) => `${parseFloat(p.value).toFixed(2)}%`, fontSize: 10, fontWeight: 'bold' },
                    markLine: {
                        symbol: 'none',
                        lineStyle: { type: 'dashed', color: 'red' },
                        data: [{ yAxis: 75, name: 'M' }],
                        label: { show: true, formatter: 'M: 75%', position: 'end' }
                    }
                }
            ]
        };
        myChart.setOption(option);
    } catch (error) {
        console.error("Error al renderizar el ranking de zonas:", error);
        container.innerHTML = '<p class="text-center text-danger">Ocurrió un error al cargar el gráfico.</p>';
    }
};
</script>