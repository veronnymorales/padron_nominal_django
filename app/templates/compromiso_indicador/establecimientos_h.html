<form method="GET" enctype="multipart/form-data" action="#" id="filter-form">
  <!-- Grupo Izquierdo - Filtros B치sicos -->
  <div class="row align-items-end">
    <!-- A침o -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary">A칌O:</label>
        <select
          class="form-control form-control-sm select2"
          id="anio"
          name="anio"
          style="width: 100%"
        >
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
    </div>
    
    <!-- Mes inicio -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary">MES INICIO:</label>
        <select
          class="form-control form-control-sm select2"
          id="mes"
          name="mes"
          style="width: 100%"
        >
          <option value="1">ENERO</option>
          <option value="2">FEBRERO</option>
          <option value="3">MARZO</option>
          <option value="4">ABRIL</option>
          <option value="5">MAYO</option>
          <option value="6">JUNIO</option>
          <option value="7">JULIO</option>
          <option value="8" selected="true">AGOSTO</option>
          <option value="9">SETIEMBRE</option>
          <option value="10">OCTUBRE</option>
          <option value="11">NOVIEMBRE</option>
          <option value="12">DICIEMBRE</option>
        </select>
      </div>
    </div>

    <!-- Mes final -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary">MES DE FINAL :</label>
        <select
          class="form-control form-control-sm select2"
          id="mes"
          name="mes"
          style="width: 100%"
        >
          <option value="1">ENERO</option>
          <option value="2">FEBRERO</option>
          <option value="3">MARZO</option>
          <option value="4">ABRIL</option>
          <option value="5">MAYO</option>
          <option value="6">JUNIO</option>
          <option value="7">JULIO</option>
          <option value="8" selected="true">AGOSTO</option>
          <option value="9">SETIEMBRE</option>
          <option value="10">OCTUBRE</option>
          <option value="11">NOVIEMBRE</option>
          <option value="12">DICIEMBRE</option>
        </select>
      </div>
    </div>

    <!-- PROVINCIA -->
    <div class="col-md-2">
      <div class="form-group">
        <label class="text-primary" for="provincias_h">PROVINCIA :</label>
        
        <select
          class="form-control form-control-sm select2"
          id="provincias_h"
          name="provincias_h"
          hx-get="{% url 'p_distritos_compromiso_indicador_h' %}"
          hx-trigger="change"
          hx-target="#p_distritos_compromiso_indicador_h"
        >
          <option value="">--- SELECCIONAR ---</option>
          {% for p in provincias_h %}
          <option value="{{ p.ubigueo_filtrado }}">{{ p.Provincia }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    
    <!--- MICRORED INCLUDE DROP INCLUYENTE --->
    <div class="col-md-2">
      <div class="form-group">
        <div id="p_distritos_compromiso_indicador_h">
          {% include 'compromiso_indicador/partials/p_microredes_establec_h.html' %}
        </div>
      </div>
    </div>
    <!--- FIN INCLUDE DROP INCLUYENTE --->
    
    
    <!-- Boton filtrar -->
    <div class="col-md-2">
      <div class="form-group">
        <button type="submit" class="btn btn-primary btn-sm" id="filter-btn">
          <i class="fas fa-filter"></i> Filtrar
        </button>
        <button type="reset" class="btn btn-default btn-sm" id="clear-btn">Limpiar</button>
      </div>
    </div>
  </div>
</form>


<!-- Estilos espec칤ficos para forzar la visualizaci칩n del campo de b칰squeda -->
<style>

  /* Ajustar altura de los selects */
  .select2-container .select2-selection--single {
    height: 31px !important;
  }

  .select2-container .select2-selection--single .select2-selection__rendered {
    line-height: 31px !important;
  }

  /* Asegurar que el dropdown tenga un z-index alto */
  .select2-dropdown {
    z-index: 9999 !important;
  }
</style>

<script>

  // Funci칩n principal para inicializar Select2
  function setupSelect2() {
    try {
      // Configuraci칩n b치sica para todos los selects
      var config = {
        width: "100%",
        minimumResultsForSearch: 0, // Siempre mostrar la b칰squeda
        placeholder: "Buscar...",
        allowClear: true,
      };

      // Inicializar cada select individualmente
      $("#anio").select2(config);
      $("#mes").select2(config);
      $("#red_h").select2(config);

      // Para los selects din치micos
      function initDynamicSelects() {
        $("select.select2")
          .not("#anio, #mes, #red_h")
          .each(function () {
            var $this = $(this);
            if (!$this.data("select2")) {
              $this.select2(config);
            }
          });
      }

      // Inicializar selects din치micos
      initDynamicSelects();

      // Manejar eventos HTMX
      document.body.addEventListener("htmx:afterSwap", function () {
        setTimeout(initDynamicSelects, 100);
      });

      // Forzar la visualizaci칩n del campo de b칰squeda cuando se abre el dropdown
      $(document).on("select2:open", function () {
        setTimeout(function () {
          // Crear un campo de b칰squeda si no existe
          var $search = $(".select2-search--dropdown");
          if ($search.length === 0 || $search.css("display") === "none") {
            var $dropdown = $(".select2-dropdown");
            if ($dropdown.length > 0) {
              if ($search.length === 0) {
                $(
                  '<span class="select2-search select2-search--dropdown">' +
                    '<input class="select2-search__field" type="search" tabindex="0" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" role="searchbox">' +
                    "</span>"
                ).prependTo($dropdown);
              } else {
                $search.show();
              }
            }
          }

          // Enfocar el campo de b칰squeda
          $(".select2-search__field").focus();
        }, 0);
      });

      // Agregar un bot칩n para mostrar el campo de b칰squeda si no aparece
      $(".select2").each(function () {
        var $select = $(this);
        var $container = $select.next(".select2-container");

        // Agregar un bot칩n de b칰squeda
        var $searchBtn = $(
          '<button type="button" class="select2-search-btn" style="position: absolute; right: 25px; top: 0; height: 100%; background: none; border: none; cursor: pointer;">游댌</button>'
        );
        $container.css("position", "relative").append($searchBtn);

        // Al hacer clic en el bot칩n, abrir el dropdown y mostrar el campo de b칰squeda
        $searchBtn.on("click", function (e) {
          e.stopPropagation();
          $select.select2("open");
          setTimeout(function () {
            $(".select2-search__field").show().focus();
          }, 0);
        });
      });
    } catch (error) {
      console.error("Error al configurar Select2:", error);
    }
  }

  // Funci칩n para manejar el formulario y mostrar/ocultar contenido
  function setupFormHandling() {
    // Manejar env칤o del formulario
    $("#filter-form").on("submit", function(e) {
      e.preventDefault();
      
      // Mostrar el contenido principal
      $("#main-content").show();
      
      // Opcional: scroll suave hacia el contenido
      $('html, body').animate({
        scrollTop: $("#main-content").offset().top - 100
      }, 500);
      
      // Aqu칤 puedes agregar l칩gica adicional para cargar datos
      // Por ejemplo, hacer una petici칩n AJAX para actualizar los gr치ficos
    });
    
    // Manejar bot칩n limpiar
    $("#clear-btn").on("click", function() {
      // Ocultar el contenido principal
      $("#main-content").hide();
      
      // Limpiar el formulario
      $("#filter-form")[0].reset();
      
      // Reinicializar los selects
      $(".select2").val(null).trigger('change');
      
      // Restaurar valores por defecto
      $("#anio").val("2025").trigger('change');
      $("#mes").val("6").trigger('change');
    });
  }
</script>
